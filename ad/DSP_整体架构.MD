# DSP整体架构
***set_daemon@126.com 2018-04-16***

## 架构图
![架构图](attachments/DSP_entire_architecture.png)

### Delivery Unit
投放单元，通过Nginx负载接入竞价流量，竞价请求为长连接。
1. 处理流程
流量适配、用户识别、地域识别、流量过滤及限流、人群查询、广告筛选、频次控制、点击率预估、价格预估、预算控制、广告Rank，竞价拼包、响应，记录日志。
2. 外部请求
* 用户识别 -- 比如PC/WAP流量，通过cookiemap数据查询对应的内部ID，这时会发起网络请求；而移动端用户，通过常见的AndroidId、Mac、IDFA和IMEI，本地处理即可。
* 人群查询 -- 使用用户ID通过网络查询人群信息，如demography、兴趣爱好，是否为可疑的作弊用户。
* 广告筛选 -- 理应通过一个分布式索引器做广告筛选。
* 频次控制 -- 查询用户在多个广告（非广告组和计划）上的当日投放次数，如果超过限制，则过滤掉该广告。
* 价格预估 -- 可能要查询计算出来的推荐广告位可能的竞价成功价格
* 预算控制 -- 请求预算控制器判别当前的广告是否可投
以上请求均会产生IO等待，即可以在这些点上做异步处理。

3. 框架

### Budget Controller
预算控制器，为投放单元提供实时预算控制。

1. 处理流程
* 优先处理控制消息，如广告主账户余额变化、计划预算变化、计划状态变化等，影响投放的信息。
* 其次是预算判别请求，由投放单元发来的请求，携带信息如[计划ID,出价]，返回[计划ID,是否可投]。
* 最后是实时推送/消耗消息，在内存中累积缓存起来，为同步数据做准备。

以上是由消息处理线程顺序处理，防止加锁。

2. 外部请求
无。

3. 框架
三种消息接入线程分别监听和接收端口数据，通过三个队列发送给顺序处理线程，并由一个缓存线程将数据刷入磁盘，防止因意外丢失数据。

4. 控制逻辑
* 判别是否该计划出价是否可行的依据是，计划是否正常、全局投放开关是否开启、“伪push量”是否超过预算和广告主账户余额，如果未超过，将该出价累计到“伪push量上”，并反馈结果给对应的投放单元，如果原来有锁，去锁，否则，“锁定”该计划状态，并记录锁定时间。
* 收到控制信息中的同步真实push数据，如果锁定时长超过5秒，则同步真实push数据到“伪push量”，并比较真实推送数据是否已经达到限额，如果是，加“二重”锁定。
* 收到控制信息中的同步真实曝光数据，如果加的是“二重锁定”，且时长超过2分钟，则同步真实曝光数据到真实push数据以及“伪push量上”，如果此时都达到限额，则标识为“绝对锁定”，否则解锁。
* 收到刷数据至磁盘的消息，则将全量数据拷贝推送给刷磁盘线程。

5. 部署
可多个实例部署，投放单元查询请求可均衡负载到这些控制器，并将推送与控制器ID关联，发生真实推送前，将推送信息发送给对应控制器，且在实时流统计时，也将来自该控制器的推送和曝光数据发送到对应的控制器上。

下发器根据控制器个数，平均分配预算给控制器。

6. 问题
可能会出现有的控制器提前消耗完预算，而有的无法消耗完，可以在投放单元使用Round Robin均衡方法。

### Monitor Unit
监控单元

### Cookemap Unit
cookiemap单元

### Log Aggregator
日志聚合器

### tempSync
临时同步器，实现小batch数据同步到BudgetController，降低接收端的压力。

### Issuer
业务数据下发器，连接投放系统和业务系统。

### Feedbacker
反馈器，将线上投放情况反馈至业务系统。

### Daily Balancer
日结算器。

### Business System
业务系统，提供业务操作服务。
